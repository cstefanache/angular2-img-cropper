{"version":3,"file":"offline_compiler.js","sourceRoot":"","sources":["../../../../modules/@angular/compiler/src/offline_compiler.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * @license\n * Copyright Google Inc. All Rights Reserved.\n *\n * Use of this source code is governed by an MIT-style license that can be\n * found in the LICENSE file at https://angular.io/license\n */\n\nimport {SchemaMetadata} from '@angular/core';\n\nimport {AnimationCompiler} from './animation/animation_compiler';\nimport {AnimationParser} from './animation/animation_parser';\nimport {CompileDirectiveMetadata, CompileIdentifierMetadata, CompileNgModuleMetadata, CompilePipeMetadata, CompileProviderMetadata, StaticSymbol, createHostComponentMeta} from './compile_metadata';\nimport {DirectiveNormalizer} from './directive_normalizer';\nimport {Identifiers, resolveIdentifier, resolveIdentifierToken} from './identifiers';\nimport {CompileMetadataResolver} from './metadata_resolver';\nimport {NgModuleCompiler} from './ng_module_compiler';\nimport {OutputEmitter} from './output/abstract_emitter';\nimport * as o from './output/output_ast';\nimport {CompiledStylesheet, StyleCompiler} from './style_compiler';\nimport {TemplateParser} from './template_parser/template_parser';\nimport {ComponentFactoryDependency, ViewCompileResult, ViewCompiler, ViewFactoryDependency} from './view_compiler/view_compiler';\n\nexport class SourceModule {\n  constructor(public moduleUrl: string, public source: string) {}\n}\n\nexport class NgModulesSummary {\n  constructor(\n      public ngModuleByComponent: Map<StaticSymbol, CompileNgModuleMetadata>,\n      public ngModules: CompileNgModuleMetadata[]) {}\n}\n\nexport function analyzeModules(\n    ngModules: StaticSymbol[], metadataResolver: CompileMetadataResolver) {\n  const ngModuleByComponent = new Map<StaticSymbol, CompileNgModuleMetadata>();\n  const modules: CompileNgModuleMetadata[] = [];\n\n  ngModules.forEach((ngModule) => {\n    const ngModuleMeta = metadataResolver.getNgModuleMetadata(<any>ngModule);\n    modules.push(ngModuleMeta);\n    ngModuleMeta.declaredDirectives.forEach((dirMeta: CompileDirectiveMetadata) => {\n      if (dirMeta.isComponent) {\n        ngModuleByComponent.set(dirMeta.type.reference, ngModuleMeta);\n      }\n    });\n  });\n  return new NgModulesSummary(ngModuleByComponent, modules);\n}\n\nexport class OfflineCompiler {\n  private _animationParser = new AnimationParser();\n  private _animationCompiler = new AnimationCompiler();\n\n  constructor(\n      private _metadataResolver: CompileMetadataResolver,\n      private _directiveNormalizer: DirectiveNormalizer, private _templateParser: TemplateParser,\n      private _styleCompiler: StyleCompiler, private _viewCompiler: ViewCompiler,\n      private _ngModuleCompiler: NgModuleCompiler, private _outputEmitter: OutputEmitter,\n      private _localeId: string, private _translationFormat: string) {}\n\n  analyzeModules(ngModules: StaticSymbol[]): NgModulesSummary {\n    return analyzeModules(ngModules, this._metadataResolver);\n  }\n\n  clearCache() {\n    this._directiveNormalizer.clearCache();\n    this._metadataResolver.clearCache();\n  }\n\n  compile(\n      moduleUrl: string, ngModulesSummary: NgModulesSummary, components: StaticSymbol[],\n      ngModules: StaticSymbol[]): Promise<SourceModule[]> {\n    const fileSuffix = _splitTypescriptSuffix(moduleUrl)[1];\n    const statements: o.Statement[] = [];\n    const exportedVars: string[] = [];\n    const outputSourceModules: SourceModule[] = [];\n\n    // compile all ng modules\n    exportedVars.push(\n        ...ngModules.map((ngModuleType) => this._compileModule(ngModuleType, statements)));\n\n    // compile components\n    return Promise\n        .all(components.map((compType) => {\n          const compMeta = this._metadataResolver.getDirectiveMetadata(<any>compType);\n          const ngModule = ngModulesSummary.ngModuleByComponent.get(compType);\n          if (!ngModule) {\n            throw new Error(`Cannot determine the module for component ${compMeta.type.name}!`);\n          }\n\n          return Promise\n              .all([compMeta, ...ngModule.transitiveModule.directives].map(\n                  dirMeta => this._directiveNormalizer.normalizeDirective(dirMeta).asyncResult))\n              .then((normalizedCompWithDirectives) => {\n                const [compMeta, ...dirMetas] = normalizedCompWithDirectives;\n                _assertComponent(compMeta);\n\n                // compile styles\n                const stylesCompileResults = this._styleCompiler.compileComponent(compMeta);\n                stylesCompileResults.externalStylesheets.forEach((compiledStyleSheet) => {\n                  outputSourceModules.push(this._codgenStyles(compiledStyleSheet, fileSuffix));\n                });\n\n                // compile components\n                exportedVars.push(\n                    this._compileComponentFactory(compMeta, fileSuffix, statements),\n                    this._compileComponent(\n                        compMeta, dirMetas, ngModule.transitiveModule.pipes, ngModule.schemas,\n                        stylesCompileResults.componentStylesheet, fileSuffix, statements));\n              });\n        }))\n        .then(() => {\n          if (statements.length > 0) {\n            outputSourceModules.unshift(this._codegenSourceModule(\n                _ngfactoryModuleUrl(moduleUrl), statements, exportedVars));\n          }\n          return outputSourceModules;\n        });\n  }\n\n  private _compileModule(ngModuleType: StaticSymbol, targetStatements: o.Statement[]): string {\n    const ngModule = this._metadataResolver.getNgModuleMetadata(ngModuleType);\n    const providers: CompileProviderMetadata[] = [];\n\n    if (this._localeId) {\n      providers.push(new CompileProviderMetadata({\n        token: resolveIdentifierToken(Identifiers.LOCALE_ID),\n        useValue: this._localeId,\n      }));\n    }\n\n    if (this._translationFormat) {\n      providers.push(new CompileProviderMetadata({\n        token: resolveIdentifierToken(Identifiers.TRANSLATIONS_FORMAT),\n        useValue: this._translationFormat\n      }));\n    }\n\n    const appCompileResult = this._ngModuleCompiler.compile(ngModule, providers);\n\n    appCompileResult.dependencies.forEach((dep) => {\n      dep.placeholder.name = _componentFactoryName(dep.comp);\n      dep.placeholder.moduleUrl = _ngfactoryModuleUrl(dep.comp.moduleUrl);\n    });\n\n    targetStatements.push(...appCompileResult.statements);\n    return appCompileResult.ngModuleFactoryVar;\n  }\n\n  private _compileComponentFactory(\n      compMeta: CompileDirectiveMetadata, fileSuffix: string,\n      targetStatements: o.Statement[]): string {\n    const hostMeta = createHostComponentMeta(compMeta);\n    const hostViewFactoryVar =\n        this._compileComponent(hostMeta, [compMeta], [], [], null, fileSuffix, targetStatements);\n    const compFactoryVar = _componentFactoryName(compMeta.type);\n    targetStatements.push(\n        o.variable(compFactoryVar)\n            .set(o.importExpr(resolveIdentifier(Identifiers.ComponentFactory), [o.importType(\n                                                                                   compMeta.type)])\n                     .instantiate(\n                         [\n                           o.literal(compMeta.selector),\n                           o.variable(hostViewFactoryVar),\n                           o.importExpr(compMeta.type),\n                         ],\n                         o.importType(\n                             resolveIdentifier(Identifiers.ComponentFactory),\n                             [o.importType(compMeta.type)], [o.TypeModifier.Const])))\n            .toDeclStmt(null, [o.StmtModifier.Final]));\n    return compFactoryVar;\n  }\n\n  private _compileComponent(\n      compMeta: CompileDirectiveMetadata, directives: CompileDirectiveMetadata[],\n      pipes: CompilePipeMetadata[], schemas: SchemaMetadata[], componentStyles: CompiledStylesheet,\n      fileSuffix: string, targetStatements: o.Statement[]): string {\n    const parsedAnimations = this._animationParser.parseComponent(compMeta);\n    const parsedTemplate = this._templateParser.parse(\n        compMeta, compMeta.template.template, directives, pipes, schemas, compMeta.type.name);\n    const stylesExpr = componentStyles ? o.variable(componentStyles.stylesVar) : o.literalArr([]);\n    const compiledAnimations =\n        this._animationCompiler.compile(compMeta.type.name, parsedAnimations);\n    const viewResult = this._viewCompiler.compileComponent(\n        compMeta, parsedTemplate, stylesExpr, pipes, compiledAnimations);\n    if (componentStyles) {\n      targetStatements.push(..._resolveStyleStatements(componentStyles, fileSuffix));\n    }\n    compiledAnimations.forEach(\n        entry => { entry.statements.forEach(statement => { targetStatements.push(statement); }); });\n    targetStatements.push(..._resolveViewStatements(viewResult));\n    return viewResult.viewFactoryVar;\n  }\n\n  private _codgenStyles(stylesCompileResult: CompiledStylesheet, fileSuffix: string): SourceModule {\n    _resolveStyleStatements(stylesCompileResult, fileSuffix);\n    return this._codegenSourceModule(\n        _stylesModuleUrl(\n            stylesCompileResult.meta.moduleUrl, stylesCompileResult.isShimmed, fileSuffix),\n        stylesCompileResult.statements, [stylesCompileResult.stylesVar]);\n  }\n\n  private _codegenSourceModule(\n      moduleUrl: string, statements: o.Statement[], exportedVars: string[]): SourceModule {\n    return new SourceModule(\n        moduleUrl, this._outputEmitter.emitStatements(moduleUrl, statements, exportedVars));\n  }\n}\n\nfunction _resolveViewStatements(compileResult: ViewCompileResult): o.Statement[] {\n  compileResult.dependencies.forEach((dep) => {\n    if (dep instanceof ViewFactoryDependency) {\n      const vfd = <ViewFactoryDependency>dep;\n      vfd.placeholder.moduleUrl = _ngfactoryModuleUrl(vfd.comp.moduleUrl);\n    } else if (dep instanceof ComponentFactoryDependency) {\n      const cfd = <ComponentFactoryDependency>dep;\n      cfd.placeholder.name = _componentFactoryName(cfd.comp);\n      cfd.placeholder.moduleUrl = _ngfactoryModuleUrl(cfd.comp.moduleUrl);\n    }\n  });\n  return compileResult.statements;\n}\n\n\nfunction _resolveStyleStatements(\n    compileResult: CompiledStylesheet, fileSuffix: string): o.Statement[] {\n  compileResult.dependencies.forEach((dep) => {\n    dep.valuePlaceholder.moduleUrl = _stylesModuleUrl(dep.moduleUrl, dep.isShimmed, fileSuffix);\n  });\n  return compileResult.statements;\n}\n\nfunction _ngfactoryModuleUrl(compUrl: string): string {\n  const urlWithSuffix = _splitTypescriptSuffix(compUrl);\n  return `${urlWithSuffix[0]}.ngfactory${urlWithSuffix[1]}`;\n}\n\nfunction _componentFactoryName(comp: CompileIdentifierMetadata): string {\n  return `${comp.name}NgFactory`;\n}\n\nfunction _stylesModuleUrl(stylesheetUrl: string, shim: boolean, suffix: string): string {\n  return shim ? `${stylesheetUrl}.shim${suffix}` : `${stylesheetUrl}${suffix}`;\n}\n\nfunction _assertComponent(meta: CompileDirectiveMetadata) {\n  if (!meta.isComponent) {\n    throw new Error(`Could not compile '${meta.type.name}' because it is not a component.`);\n  }\n}\n\nfunction _splitTypescriptSuffix(path: string): string[] {\n  if (path.endsWith('.d.ts')) {\n    return [path.slice(0, -5), '.ts'];\n  }\n\n  const lastDot = path.lastIndexOf('.');\n\n  if (lastDot !== -1) {\n    return [path.substring(0, lastDot), path.substring(lastDot)];\n  }\n\n  return [path, ''];\n}\n\ninterface DecoratorInvocation {\n  type: Function;\n  args?: any[];\n}\n"]}