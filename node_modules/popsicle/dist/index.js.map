{"version":3,"file":"index.js","sourceRoot":"","sources":["../lib/index.ts"],"names":[],"mappings":"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","sourcesContent":["import { request as httpRequest, IncomingMessage, ClientRequest } from 'http'\nimport { request as httpsRequest, RequestOptions } from 'https'\nimport { PassThrough } from 'stream'\nimport urlLib = require('url')\nimport extend = require('xtend')\nimport arrify = require('arrify')\nimport concat = require('concat-stream')\nimport { Cookie } from 'tough-cookie'\nimport Promise = require('any-promise')\nimport { createUnzip } from 'zlib'\nimport { Headers } from './base'\nimport Request from './request'\nimport Response from './response'\nimport { stringify, headers } from './plugins/index'\n\nexport type Types = 'text' | 'buffer' | 'array' | 'uint8array' | 'stream' | string\n\n/**\n * List of valid node response types.\n */\nconst validTypes = ['text', 'buffer', 'array', 'uint8array', 'stream']\n\n/**\n * Node transport options.\n */\nexport interface Options {\n  type?: Types\n  unzip?: boolean\n  jar?: any\n  agent?: any\n  maxRedirects?: number\n  rejectUnauthorized?: boolean\n  followRedirects?: boolean\n  confirmRedirect?: (request: ClientRequest, response: IncomingMessage) => boolean\n  ca?: string | Buffer | Array<string | Buffer>\n  cert?: string | Buffer\n  key?: string | Buffer\n  maxBufferSize?: number\n}\n\n/**\n * Create a transport object.\n */\nexport function createTransport (options: Options) {\n  return {\n    use,\n    abort,\n    open (request: Request) {\n      return handle(request, options)\n    }\n  }\n}\n\n/**\n * Default uses.\n */\nconst use = [stringify(), headers()]\n\n/**\n * Redirection types to handle.\n */\nenum REDIRECT_TYPE {\n  FOLLOW_WITH_GET,\n  FOLLOW_WITH_CONFIRMATION\n}\n\n/**\n * Possible redirection status codes.\n */\nconst REDIRECT_STATUS: { [status: number]: number } = {\n  '300': REDIRECT_TYPE.FOLLOW_WITH_GET,\n  '301': REDIRECT_TYPE.FOLLOW_WITH_GET,\n  '302': REDIRECT_TYPE.FOLLOW_WITH_GET,\n  '303': REDIRECT_TYPE.FOLLOW_WITH_GET,\n  '305': REDIRECT_TYPE.FOLLOW_WITH_GET,\n  '307': REDIRECT_TYPE.FOLLOW_WITH_CONFIRMATION,\n  '308': REDIRECT_TYPE.FOLLOW_WITH_CONFIRMATION\n}\n\n/**\n * Open a HTTP request with node.\n */\nfunction handle (request: Request, options: Options) {\n  const { followRedirects, type, unzip, rejectUnauthorized, ca, key, cert, agent } = options\n  const { url, method, body } = request\n  const maxRedirects = num(options.maxRedirects, 5)\n  const maxBufferSize = num(options.maxBufferSize, type === 'stream' ? Infinity : 2 * 1000 * 1000)\n  const storeCookies = getStoreCookies(request, options)\n  const attachCookies = getAttachCookies(request, options)\n  const confirmRedirect = options.confirmRedirect || falsey\n  let requestCount = 0\n\n  if (type && validTypes.indexOf(type) === -1) {\n    return Promise.reject(\n      request.error(`Unsupported type: ${type}`, 'ETYPE')\n    )\n  }\n\n  // Automatically enable unzipping.\n  if (unzip !== false && request.get('Accept-Encoding') == null) {\n    request.set('Accept-Encoding', 'gzip,deflate')\n  }\n\n  /**\n   * Create the HTTP request, in a way we can re-use this.\n   */\n  function get (url: string, method: string, body?: any) {\n    // Check redirection count before executing request.\n    if (requestCount++ > maxRedirects) {\n      return Promise.reject(\n        request.error(`Exceeded maximum of ${maxRedirects} redirects`, 'EMAXREDIRECTS')\n      )\n    }\n\n    return attachCookies(url)\n      .then(function () {\n        return new Promise((resolve, reject) => {\n          const arg: any = urlLib.parse(url)\n          const isHttp = arg.protocol !== 'https:'\n          const engine: typeof httpRequest = isHttp ? httpRequest : httpsRequest\n\n          // Attach request options.\n          arg.method = method\n          arg.headers = request.toHeaders()\n          arg.agent = agent\n          arg.rejectUnauthorized = rejectUnauthorized !== false\n          arg.ca = ca\n          arg.cert = cert\n          arg.key = key\n\n          const rawRequest = engine(arg)\n\n          // Track upload/download progress through a stream.\n          const requestStream = new PassThrough()\n          const responseStream = new PassThrough()\n          let uploadedBytes = 0\n          let downloadedBytes = 0\n\n          requestStream.on('data', function (chunk: Buffer) {\n            uploadedBytes += chunk.length\n            request._setUploadedBytes(uploadedBytes)\n          })\n\n          requestStream.on('end', function () {\n            request._setUploadedBytes(uploadedBytes, 1)\n          })\n\n          responseStream.on('data', function (chunk: Buffer) {\n            downloadedBytes += chunk.length\n            request._setDownloadedBytes(downloadedBytes)\n\n            // Abort on the max buffer size.\n            if (downloadedBytes > maxBufferSize) {\n              rawRequest.abort()\n              responseStream.emit('error', request.error('Response too large', 'ETOOLARGE'))\n            }\n          })\n\n          responseStream.on('end', function () {\n            request._setDownloadedBytes(downloadedBytes, 1)\n          })\n\n          // Handle the HTTP response.\n          function response (incomingMessage: IncomingMessage) {\n            const { headers, rawHeaders, statusCode: status, statusMessage: statusText } = incomingMessage\n            const redirect = REDIRECT_STATUS[status]\n\n            // Handle HTTP redirects.\n            if (followRedirects !== false && redirect != null && headers.location) {\n              const newUrl = urlLib.resolve(url, headers.location)\n\n              // Ignore the result of the response on redirect.\n              incomingMessage.resume()\n\n              if (redirect === REDIRECT_TYPE.FOLLOW_WITH_GET) {\n                // Update the \"Content-Length\" for updated redirection body.\n                request.set('Content-Length', '0')\n\n                return get(newUrl, 'GET')\n              }\n\n              if (redirect === REDIRECT_TYPE.FOLLOW_WITH_CONFIRMATION) {\n                // Following HTTP spec by automatically redirecting with GET/HEAD.\n                if (arg.method === 'GET' || arg.method === 'HEAD') {\n                  return get(newUrl, method, body)\n                }\n\n                // Allow the user to confirm redirect according to HTTP spec.\n                if (confirmRedirect(rawRequest, incomingMessage)) {\n                  return get(newUrl, method, body)\n                }\n              }\n            }\n\n            request.downloadLength = num(headers['content-length'], null)\n            incomingMessage.pipe(responseStream)\n\n            return handleResponse(request, responseStream, headers, options)\n              .then(function (body) {\n                return new Response({\n                  status,\n                  headers,\n                  statusText,\n                  rawHeaders,\n                  body,\n                  url\n                })\n              })\n          }\n\n          // Emit a request error.\n          function emitError (error: Error) {\n            // Abort request on error.\n            rawRequest.abort()\n            reject(error)\n          }\n\n          rawRequest.on('response', function (message: IncomingMessage) {\n            resolve(storeCookies(url, message.headers).then(() => response(message)))\n          })\n\n          rawRequest.on('error', function (error: Error) {\n            emitError(request.error(`Unable to connect to \"${url}\"`, 'EUNAVAILABLE', error))\n          })\n\n          request._raw = rawRequest\n          request.uploadLength = num(rawRequest.getHeader('content-length'), null)\n          requestStream.pipe(rawRequest)\n          requestStream.on('error', emitError)\n\n          // Pipe the body to the stream.\n          if (body) {\n            if (typeof body.pipe === 'function') {\n              body.pipe(requestStream)\n              body.on('error', emitError)\n            } else {\n              requestStream.end(body)\n            }\n          } else {\n            requestStream.end()\n          }\n        })\n      })\n  }\n\n  return get(url, method, body)\n}\n\n/**\n * Close the current HTTP request.\n */\nfunction abort (request: Request) {\n  request._raw.abort()\n}\n\n/**\n * Parse a value into a number.\n */\nfunction num (value: any, fallback?: number) {\n  if (value == null) {\n    return fallback\n  }\n\n  return isNaN(value) ? fallback : Number(value)\n}\n\n/**\n * Used to check redirection support.\n */\nfunction falsey () {\n  return false\n}\n\n/**\n * Read cookies from the cookie jar.\n */\nfunction getAttachCookies (request: Request, options: Options): (url: string) => Promise<any> {\n  const { jar } = options\n  const cookie = request.getAll('Cookie')\n\n  if (!jar) {\n    return () => Promise.resolve()\n  }\n\n  return function (url: string) {\n    return new Promise(function (resolve, reject) {\n      request.set('Cookie', cookie)\n\n      options.jar.getCookies(url, function (err: Error, cookies: Cookie[]) {\n        if (err) {\n          return reject(err)\n        }\n\n        if (cookies.length) {\n          request.append('Cookie', cookies.join('; '))\n        }\n\n        return resolve()\n      })\n    })\n  }\n}\n\n/**\n * Put cookies in the cookie jar.\n */\nfunction getStoreCookies (request: Request, options: Options): (url: string, headers: { [key: string]: any }) => Promise<any> {\n  const { jar } = options\n\n  if (!jar) {\n    return () => Promise.resolve()\n  }\n\n  return function (url, headers) {\n    const cookies = arrify(headers['set-cookie'])\n\n    if (!cookies.length) {\n      return Promise.resolve()\n    }\n\n    const storeCookies = cookies.map(function (cookie) {\n      return new Promise(function (resolve, reject) {\n        jar.setCookie(cookie, url, { ignoreError: true }, function (err: Error) {\n          return err ? reject(err) : resolve()\n        })\n      })\n    })\n\n    return Promise.all(storeCookies)\n  }\n}\n\n/**\n * Handle the HTTP response body encoding.\n */\nfunction handleResponse (\n  request: Request,\n  stream: PassThrough,\n  headers: { [key: string]: any },\n  options: Options\n) {\n  const type = options.type || 'text'\n  const unzip = options.unzip !== false\n\n  const result = new Promise<any>((resolve, reject) => {\n    if (unzip) {\n      const enc = headers['content-encoding']\n\n      if (enc === 'deflate' || enc === 'gzip') {\n        const unzip = createUnzip()\n        stream.pipe(unzip)\n        stream.on('error', (err: Error) => unzip.emit('error', err))\n        stream = unzip\n      }\n    }\n\n    // Return the raw stream.\n    if (type === 'stream') {\n      return resolve(stream)\n    }\n\n    const encoding = type === 'text' ? 'string' : type\n    const concatStream = concat({ encoding }, resolve)\n\n    stream.on('error', reject)\n    stream.pipe(concatStream)\n  })\n\n  return result\n}\n"]}